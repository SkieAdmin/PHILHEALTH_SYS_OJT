{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}{{ form.instance.pk|yesno:"Update Patient,Add New Patient" }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center py-3 border-bottom">
    <div>
        <h2>{{ form.instance.pk|yesno:"Update Patient,Add New Patient" }}</h2>
        <p class="text-muted mb-0">Enter patient information</p>
    </div>
    <div>
        <a href="{% url 'patient_list' %}" class="btn btn-secondary">Back to List</a>
    </div>
</div>

<!-- Patient Form -->
<form method="post" enctype="multipart/form-data" class="mt-4">
    {% csrf_token %}

    <!-- Patient Information Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Patient Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name</label>
                    {{ form.first_name }}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name</label>
                    {{ form.last_name }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.birth_date.id_for_label }}" class="form-label">Birth Date</label>
                    {{ form.birth_date }}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.gender.id_for_label }}" class="form-label">Gender</label>
                    {{ form.gender }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.contact_number.id_for_label }}" class="form-label">Contact Number</label>
                    {{ form.contact_number }}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                    {{ form.email }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.address.id_for_label }}" class="form-label">Address</label>
                    {{ form.address }}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.medical_history.id_for_label }}" class="form-label">Medical History</label>
                    {{ form.medical_history }}
                </div>
            </div>
        </div>
    </div>

    <!-- Medical Record Document Upload Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Medical Record Document (Optional)</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Upload a document related to the patient's medical records.</p>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="id_document" class="form-label">Document</label>
                    <input type="file" class="form-control" name="document" id="id_document" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif">
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="id_description" class="form-label">Description</label>
                    <input type="text" class="form-control" name="description" id="id_description" placeholder="Enter description for document">
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Picture Upload Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Patient Picture (Optional)</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Upload a picture of the patient.</p>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="id_picture" class="form-label">Picture</label>
                    <input type="file" class="form-control" name="picture" id="id_picture" accept="image/*">
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="id_caption" class="form-label">Caption</label>
                    <input type="text" class="form-control" name="caption" id="id_caption" placeholder="Enter caption for picture">
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Documents Section -->
    {% if patient %}
        {% if patient.documents.all %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Existing Documents</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for doc in patient.documents.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{{ doc.document.url }}" target="_blank">{{ doc.original_filename|default:doc.document.name }}</a>
                            {% if doc.description %}<span class="text-muted"> - {{ doc.description }}</span>{% endif %}
                        </div>
                        <form method="post" action="{% url 'delete_patient_document' doc.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        {% if patient.pictures.all %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Existing Pictures</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for pic in patient.pictures.all %}
                    <div class="col-md-3 col-sm-4 col-6 mb-3">
                        <div class="card">
                            <a href="{{ pic.picture.url }}" target="_blank">
                                <img src="{{ pic.picture.url }}" class="card-img-top" alt="{{ pic.caption|default:'Patient picture' }}">
                            </a>
                            <div class="card-body p-2">
                                {% if pic.caption %}<p class="card-text small">{{ pic.caption }}</p>{% endif %}
                                <form method="post" action="{% url 'delete_patient_picture' pic.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger w-100">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    {% endif %}

    <!-- Action Buttons -->
    <div class="mb-4">
        <button type="submit" class="btn btn-primary">Save</button>
        <a href="{% url 'patient_list' %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formInputs = document.querySelectorAll('input:not([type="file"]):not([type="submit"]), select, textarea');
    formInputs.forEach(input => {
        input.classList.add('form-control');
    });
});
</script>
{% endblock %}