{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Billing - {{ patient.first_name }} {{ patient.last_name }}{% endblock %}

{% block content %}
<!-- (12-19-2025) Gocotano - Billing detail page showing patient info, diagnosis, and billing -->

<!-- Header -->
<div class="d-flex justify-content-between align-items-center py-3 border-bottom">
    <div>
        <h2>Billing Details</h2>
        <p class="text-muted mb-0">{{ patient.first_name }} {{ patient.last_name }}</p>
    </div>
    <a href="{% url 'finance_dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
</div>

<!-- (12-19-2025) Gocotano - Django Messages -->
{% if messages %}
<div class="mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="row mt-4">
    <!-- (12-19-2025) Gocotano - Patient Information Card -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Patient Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Name:</strong> {{ patient.first_name }} {{ patient.last_name }}</p>
                <p><strong>Birth Date:</strong> {{ patient.birth_date }}</p>
                <p><strong>Gender:</strong> {{ patient.gender }}</p>
                <p><strong>Contact:</strong> {{ patient.contact_number }}</p>
                <p><strong>Email:</strong> {{ patient.email|default:"-" }}</p>
                <p><strong>Address:</strong> {{ patient.address|default:"-" }}</p>
            </div>
        </div>
    </div>

    <!-- (12-19-2025) Gocotano - Consultation/Diagnosis Card -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Consultation Details</h5>
            </div>
            <div class="card-body">
                <!-- (12-19-2025) Gocotano - Show assigned doctor from appointment (DoctorProfile has its own name fields) -->
                <p><strong>Assigned Doctor:</strong> Dr. {{ assigned_doctor.first_name }} {{ assigned_doctor.last_name }}</p>
                <p><strong>Date:</strong> {{ consultation.date|date:"M d, Y H:i" }}</p>
                <p><strong>Diagnosis:</strong> {{ consultation.diagnosis }}</p>
                {% if consultation.reason_notes %}
                <p><strong>Reason Notes:</strong> {{ consultation.reason_notes }}</p>
                {% endif %}
                {% if consultation.notes %}
                <p><strong>Additional Notes:</strong> {{ consultation.notes }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- (12-19-2025) Gocotano - Bill Status Card -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Bill Status</h5>
    </div>
    <div class="card-body">
        <!-- (12-19-2025) Gocotano - Billing Items Table (Medicines) -->
        <h6>Prescribed Medicines</h6>
        <table class="table table-bordered table-sm">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for prescription in prescriptions %}
                <tr>
                    <td>{{ prescription.medicine.name }}</td>
                    <td>{{ prescription.quantity }}</td>
                    <td>{{ prescription.medicine.price }}</td>
                    <td>{{ prescription.get_total_price }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center">No medicines prescribed.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- (12-19-2025) Gocotano - Billing Summary -->
        <div class="row mt-4">
            <div class="col-md-6">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>Total Amount:</strong></td>
                        <td class="text-end">{{ billing.total_amount }}</td>
                    </tr>
                    <tr>
                        <td><strong>PhilHealth Coverage:</strong></td>
                        <td class="text-end text-success">- {{ billing.philhealth_coverage }}</td>
                    </tr>
                    <tr>
                        <td><strong>Amount Paid:</strong></td>
                        <td class="text-end text-success">- {{ billing.amount_paid }}</td>
                    </tr>
                    <tr class="border-top">
                        <td><strong>Balance Due:</strong></td>
                        <td class="text-end fw-bold">{{ balance }}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6 text-end">
                <!-- (12-19-2025) Gocotano - Status Badge -->
                <p>
                    <strong>Status:</strong>
                    {% if billing.status == 'PENDING' %}
                        <span class="badge bg-warning text-dark">Pending</span>
                    {% elif billing.status == 'PARTIAL' %}
                        <span class="badge bg-info">Partially Paid</span>
                    {% elif billing.status == 'PAID' %}
                        <span class="badge bg-success">Paid</span>
                    {% elif billing.status == 'PHILHEALTH' %}
                        <span class="badge bg-primary">PhilHealth-Covered</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- (12-19-2025) Gocotano - Payment Form Card -->
{% if billing.status != 'PAID' and billing.status != 'PHILHEALTH' %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Process Payment</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- (12-19-2025) Gocotano - Cash Payment Form -->
            <div class="col-md-6">
                <h6>Cash Payment</h6>
                <form method="POST" action="{% url 'process_payment' billing.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="payment_method" value="CASH">
                    <div class="mb-3">
                        <label class="form-label">Amount</label>
                        <input type="number" step="0.01" class="form-control" name="amount" value="{{ balance }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Remarks (Optional)</label>
                        <textarea class="form-control" name="remarks" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Process Cash Payment</button>
                </form>
            </div>

            <!-- (12-19-2025) Gocotano - PhilHealth Coverage Form -->
            <div class="col-md-6">
                <h6>PhilHealth Coverage</h6>
                <form method="POST" action="{% url 'apply_philhealth' billing.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">PhilHealth Claim Number</label>
                        <input type="text" class="form-control" name="reference_number" placeholder="Enter claim number...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Remarks (Optional)</label>
                        <textarea class="form-control" name="remarks" rows="2">PhilHealth Full Coverage</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Apply PhilHealth Coverage</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- (12-19-2025) Gocotano - Transaction History Card -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Transaction History</h5>
    </div>
    <div class="card-body">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Payment Method</th>
                    <th>Amount</th>
                    <th>Reference #</th>
                    <th>Remarks</th>
                    <th>Processed By</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions %}
                <tr>
                    <td>{{ transaction.created_at|date:"M d, Y H:i" }}</td>
                    <td>
                        {% if transaction.payment_method == 'CASH' %}
                            <span class="badge bg-success">Cash</span>
                        {% else %}
                            <span class="badge bg-primary">PhilHealth</span>
                        {% endif %}
                    </td>
                    <td>{{ transaction.amount }}</td>
                    <td>{{ transaction.reference_number|default:"-" }}</td>
                    <td>{{ transaction.remarks|default:"-" }}</td>
                    <!-- (12-19-2025) Gocotano - Show username if first/last name is empty -->
                    <td>
                        {% if transaction.processed_by.first_name or transaction.processed_by.last_name %}
                            {{ transaction.processed_by.first_name }} {{ transaction.processed_by.last_name }}
                        {% else %}
                            {{ transaction.processed_by.username|default:"-" }}
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No transactions recorded yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
