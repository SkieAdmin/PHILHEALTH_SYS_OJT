{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Patient - {{ patient.first_name }} {{ patient.last_name }}{% endblock %}

{% block content %}
<!-- (12/18/2025 - Gocotano) - My Patient Detail page showing patient info and consultations -->

<!-- Header -->
<div class="d-flex justify-content-between align-items-center py-3 border-bottom">
    <div>
        <h2>{{ patient.first_name }} {{ patient.last_name }}</h2>
        <p class="text-muted mb-0">Patient Details and Consultation History</p>
    </div>
    <a href="{% url 'my_patients' %}" class="btn btn-secondary">Back to My Patients</a>
</div>

<div class="row mt-4">
    <!-- (12/18/2025 - Gocotano) - Patient Information Card -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Patient Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Name:</strong> {{ patient.first_name }} {{ patient.last_name }}</p>
                <p><strong>Birth Date:</strong> {{ patient.birth_date }}</p>
                <p><strong>Gender:</strong> {{ patient.gender }}</p>
                <p><strong>Contact:</strong> {{ patient.contact_number }}</p>
                <p><strong>Email:</strong> {{ patient.email|default:"-" }}</p>
                <p><strong>Address:</strong> {{ patient.address|default:"-" }}</p>
            </div>
        </div>
    </div>

    <!-- (12/18/2025 - Gocotano) - Medical History Card -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Medical History</h5>
            </div>
            <div class="card-body">
                {% if patient.medical_history %}
                    <p>{{ patient.medical_history }}</p>
                {% else %}
                    <p class="text-muted mb-0">No medical history recorded.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- (12/18/2025 - Gocotano) - Medical Records / Documents -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Medical Records / Documents</h5>
    </div>
    <div class="card-body">
        {% if documents %}
            <ul class="list-group">
                {% for doc in documents %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <a href="{{ doc.document.url }}" target="_blank">{{ doc.original_filename|default:doc.document.name }}</a>
                        {% if doc.description %} - {{ doc.description }}{% endif %}
                    </div>
                    <small class="text-muted">Uploaded: {{ doc.uploaded_at|date:"M d, Y" }}</small>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted mb-0">No documents uploaded.</p>
        {% endif %}
    </div>
</div>


<!-- (12/18/2025 - Gocotano) - Appointment History -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Appointment History</h5>
    </div>
    <div class="card-body">
        {% if appointments %}
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for appt in appointments %}
                    <tr>
                        <td>{{ appt.date|date:"M d, Y" }}</td>
                        <td>{{ appt.time }}</td>
                        <td>
                            {% if appt.status == 'PENDING' %}
                                <span class="badge bg-warning text-dark">Pending</span>
                            {% elif appt.status == 'APPROVE' %}
                                <span class="badge bg-success">Approved</span>
                            {% elif appt.status == 'COMPLETED' %}
                                <span class="badge bg-primary">Completed</span>
                            {% elif appt.status == 'CANCELLED' %}
                                <span class="badge bg-danger">Cancelled</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ appt.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ appt.notes|default:"-" }}</td>
                        <td>
                            {% if appt.status == 'APPROVE' %}
                                <a href="{% url 'add_consultation' appt.id %}" class="btn btn-sm btn-primary">Start Consultation</a>
                            {% elif appt.status == 'COMPLETED' %}
                                <span class="text-muted">Completed</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-muted mb-0">No appointments found.</p>
        {% endif %}
    </div>
</div>

<!-- (12/18/2025 - Gocotano) - Consultation List -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Consultation History</h5>
    </div>
    <div class="card-body">
        {% if consultations %}
            <div class="accordion" id="consultationAccordion">
                {% for consultation in consultations %}
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#consultation{{ consultation.id }}">
                            Consultation - {{ consultation.date|date:"M d, Y H:i" }} | Diagnosis: {{ consultation.diagnosis|truncatewords:5 }}
                        </button>
                    </h2>
                    <div id="consultation{{ consultation.id }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" data-bs-parent="#consultationAccordion">
                        <div class="accordion-body">
                            <!-- (12/18/2025 - Gocotano) - Consultation Details -->
                            <p><strong>Diagnosis:</strong> {{ consultation.diagnosis }}</p>
                            {% if consultation.reason_notes %}
                                <p><strong>Reason Notes:</strong> {{ consultation.reason_notes }}</p>
                            {% endif %}
                            {% if consultation.notes %}
                                <p><strong>Additional Notes:</strong> {{ consultation.notes }}</p>
                            {% endif %}

                            <!-- (12/18/2025 - Gocotano) - Prescriptions for this consultation -->
                            {% if consultation.prescriptions.all %}
                                <h6 class="mt-3">Prescriptions:</h6>
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Medicine</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                            <th>Instructions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for prescription in consultation.prescriptions.all %}
                                        <tr>
                                            <td>{{ prescription.medicine.name }}</td>
                                            <td>{{ prescription.quantity }}</td>
                                            <td>₱{{ prescription.medicine.price }}</td>
                                            <td>₱{{ prescription.get_total_price }}</td>
                                            <td>{{ prescription.doctor_prescription|default:"-" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <p class="text-muted"><em>No prescriptions for this consultation.</em></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted mb-0">No consultations recorded.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
